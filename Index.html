<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Server Ping Monitor</title>
    <style>
        :root {
            --green: #4CAF50;
            --amber: #FF9800;
            --red: #F44336;
            --blue: #2196F3;
            --dark: #121212;
            --light: #f0f0f0;
            --card-bg: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #444;
            --gray: #9e9e9e;

            /* Bright but non-red/orange/green/blue badge colors */
            --app-bg: #4DB6AC;    /* Teal */
            --app-text: white;
            --env-bg: #7986CB;    /* Indigo */
            --env-text: white;
            --type-bg: #FF8A65;   /* Coral */
            --type-text: white;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            padding: 16px;
            font-size: 0.92rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        h1 { 
            font-size: 1.6rem; 
            font-weight: 600; 
            color: var(--text-primary);
        }
        .controls { display: flex; gap: 12px; align-items: center; }
        .group-selector {
            display: flex;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .group-option {
            padding: 7px 14px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .group-option.active {
            background: #555;
            color: white;
        }
        .group-option:not(.active):hover {
            background: #444;
            color: white;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            background: var(--card-bg);
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            margin: 18px 0;
            font-size: 0.88rem;
        }
        .legend-item { display: flex; align-items: center; gap: 7px; }
        .led, .status-led {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.4);
        }
        .led.green, .status-led.green { background: var(--green); }
        .led.amber, .status-led.amber { background: var(--amber); }
        .led.red, .status-led.red { background: var(--red); }
        .led.red.blink, .status-led.red.blink { animation: blink-red 1.2s infinite; }
        .led.blue.blink, .status-led.blue.blink { animation: blink-blue 1.4s infinite; }

        .status-led {
            width: 20px;
            height: 20px;
            margin-bottom: 6px;
            box-shadow: 0 0 7px rgba(0,0,0,0.5);
        }

        @keyframes blink-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes blink-blue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        .group-card {
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }
        .group-header {
            padding: 10px 16px;
            background: #202020;
            color: white;
            font-weight: 600;
            font-size: 1.0rem;
        }
        .servers-list {
            list-style: none;
        }
        .server-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px; /* Reduced vertical padding */
            border-bottom: 1px solid #404040;
        }
        .server-item:last-child { border-bottom: none; }
        .server-info { flex: 1; }
        .server-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.0rem;
            color: white;
        }
        .badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .badge {
            padding: 4px 8px;           /* Reduced padding */
            border-radius: 8px;         /* Less curvature */
            font-size: 0.78rem;         /* Smaller font */
            font-weight: 600;
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .badge.app { background-color: var(--app-bg); color: var(--app-text); }
        .badge.env { background-color: var(--env-bg); color: var(--env-text); }
        .badge.type { background-color: var(--type-bg); color: var(--type-text); }
        .ip-address {
            font-size: 0.82rem;
            color: var(--gray);
            margin-bottom: 6px;
        }
        .last-checked {
            font-size: 0.72rem;
            color: #888;
        }
        .status-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 55px;
        }
        footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 18px;
            color: var(--gray);
            border-top: 1px solid var(--border);
            font-size: 0.88rem;
        }
        @media (max-width: 768px) {
            .groups-container { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .server-item { flex-direction: column; gap: 10px; padding: 12px; }
            .status-display { flex-direction: row; gap: 10px; width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Server Ping Monitor Dashboard</h1>
            <div class="controls">
                <div class="group-selector">
                    <div class="group-option active" data-group="status">Status</div>
                    <div class="group-option" data-group="application">Application</div>
                    <div class="group-option" data-group="environment">Environment</div>
                    <div class="group-option" data-group="type">Type</div>
                </div>
            </div>
        </header>
        <div class="legend">
            <div class="legend-item"><div class="led green"></div> Online (100%)</div>
            <div class="legend-item"><div class="led amber"></div> Partial (â‰¤50%)</div>
            <div class="legend-item"><div class="led red blink"></div> Offline (0%)</div>
            <div class="legend-item"><div class="led blue blink"></div> Invalid IP</div>
        </div>
        <div id="groupsContainer" class="groups-container">
            <!-- Groups rendered here -->
        </div>
        <footer>
            <p>Last updated: <span id="lastUpdate">Never</span></p>
        </footer>
    </div>
    <script>
        const DATA_FILE = 'server-status.json';
        const REFRESH_INTERVAL = 30000;
        let currentGroup = 'status';
        function isValidIPv4(ip) {
            if (!ip || ip === "N/A" || ip.trim() === "") return false;
            const blocks = ip.split('.');
            if (blocks.length !== 4) return false;
            return blocks.every(block => {
                const num = Number(block);
                return !isNaN(num) && num >= 0 && num <= 255 && String(num) === block;
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.group-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.group-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentGroup = btn.dataset.group;
                    renderDashboard(window.serversData || []);
                });
            });
            loadData();
            setInterval(loadData, REFRESH_INTERVAL);
        });
        async function loadData() {
            try {
                const res = await fetch(`${DATA_FILE}?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error('Network response not OK');
                const data = await res.json();
                window.serversData = Array.isArray(data) ? data : [];
                renderDashboard(window.serversData);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (err) {
                console.error('Failed to load ', err);
                document.getElementById('groupsContainer').innerHTML = 
                    `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#aaa;">
                        Error loading server data. Ensure monitor.ps1 is running.
                    </div>`;
            }
        }
        function getLEDClass(server) {
            const ip = server.IP;
            if (!ip || ip === "N/A" || ip.trim() === "") {
                return "blue blink";
            }
            let pct = parseFloat(server.SuccessPercentage);
            if (isNaN(pct)) pct = 0;
            const ipValid = isValidIPv4(ip);
            if (!ipValid) {
                return "blue blink";
            }
            if (pct === 0) {
                return "red blink";
            } else if (pct <= 50) {
                return "amber";
            } else {
                return "green";
            }
        }
        function renderDashboard(servers) {
            const container = document.getElementById('groupsContainer');
            if (!servers || servers.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#aaa;">No servers to display</div>';
                return;
            }
            const groups = {};
            servers.forEach(s => {
                const ledClass = getLEDClass(s);
                let key;
                switch(currentGroup) {
                    case 'status':
                        if (ledClass.includes("blue")) key = "Invalid IP";
                        else if (ledClass.includes("red")) key = "Offline";
                        else if (ledClass.includes("amber")) key = "Partial";
                        else key = "Online";
                        break;
                    case 'application':
                        key = s.Application || 'Unknown';
                        break;
                    case 'environment':
                        key = s.Environment || 'Unknown';
                        break;
                    case 'type':
                        key = s.Type || 'Unknown';
                        break;
                    default:
                        key = 'Other';
                }
                if (!groups[key]) groups[key] = [];
                groups[key].push({ ...s, LEDClass: ledClass });
            });
            container.innerHTML = '';
            Object.keys(groups).sort().forEach(groupName => {
                const card = document.createElement('div');
                card.className = 'group-card';
                const header = document.createElement('div');
                header.className = 'group-header';
                header.textContent = `${groupName} (${groups[groupName].length})`;
                card.appendChild(header);
                const list = document.createElement('ul');
                list.className = 'servers-list';
                groups[groupName].forEach(s => {
                    const item = document.createElement('li');
                    item.className = 'server-item';
                    const info = document.createElement('div');
                    info.className = 'server-info';
                    const name = document.createElement('div');
                    name.className = 'server-name';
                    name.textContent = s.Name;
                    info.appendChild(name);
                    const badges = document.createElement('div');
                    badges.className = 'badges';
                    const appBadge = document.createElement('span');
                    appBadge.className = 'badge app';
                    appBadge.textContent = s.Application || 'N/A';
                    badges.appendChild(appBadge);
                    const envBadge = document.createElement('span');
                    envBadge.className = 'badge env';
                    envBadge.textContent = s.Environment || 'N/A';
                    badges.appendChild(envBadge);
                    const typeBadge = document.createElement('span');
                    typeBadge.className = 'badge type';
                    typeBadge.textContent = s.Type || 'N/A';
                    badges.appendChild(typeBadge);
                    info.appendChild(badges);
                    const ipDiv = document.createElement('div');
                    ipDiv.className = 'ip-address';
                    ipDiv.textContent = s.IP || 'N/A';
                    info.appendChild(ipDiv);
                    const lastChecked = document.createElement('div');
                    lastChecked.className = 'last-checked';
                    lastChecked.textContent = `Last checked: ${s.LastChecked}`;
                    info.appendChild(lastChecked);
                    const statusDisplay = document.createElement('div');
                    statusDisplay.className = 'status-display';
                    const led = document.createElement('div');
                    led.className = `status-led ${s.LEDClass}`;
                    statusDisplay.appendChild(led);
                    item.appendChild(info);
                    item.appendChild(statusDisplay);
                    list.appendChild(item);
                });
                card.appendChild(list);
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>